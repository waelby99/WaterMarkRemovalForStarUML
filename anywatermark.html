<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Suppression watermark - Ã©tape par Ã©tape</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f4f4f4;
    }
    canvas {
      border: 1px solid #ccc;
      margin-top: 10px;
      cursor: crosshair;
      max-width: 100%;
    }
    .color-list {
      display: inline-block;
      margin-top: 10px;
    }
    .color-box {
      width: 20px;
      height: 20px;
      display: inline-block;
      margin: 2px;
      border: 1px solid #444;
    }
  </style>
</head>
<body>
  <h2>ğŸ–Œï¸ Ã‰tape 1 : Choisissez les couleurs du watermark</h2>
  <input type="file" id="upload" accept="image/*"><br><br>
  <canvas id="canvas"></canvas><br>

  <div class="color-list" id="colorList"></div><br>

  <button onclick="clearColors()">ğŸ” RÃ©initialiser couleurs</button>
  <button onclick="removeWatermark()">ğŸ§½ Supprimer le watermark</button>
  <button onclick="saveImage()">ğŸ’¾ TÃ©lÃ©charger lâ€™image</button>

  <script>
    const upload = document.getElementById('upload');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const colorListDiv = document.getElementById("colorList");
    let selectedColors = [];
    let imgLoaded = false;

    upload.onchange = function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const img = new Image();
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        imgLoaded = true;
        selectedColors = [];
        updateColorList();
      };
      img.src = URL.createObjectURL(file);
    };

    canvas.addEventListener("click", function (e) {
      if (!imgLoaded) return;
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor(e.clientX - rect.left);
      const y = Math.floor(e.clientY - rect.top);
      const pixel = ctx.getImageData(x, y, 1, 1).data;
      const rgb = { r: pixel[0], g: pixel[1], b: pixel[2] };
      selectedColors.push(rgb);
      updateColorList();
    });

    function updateColorList() {
      colorListDiv.innerHTML = '';
      selectedColors.forEach(c => {
        const box = document.createElement('div');
        box.className = 'color-box';
        box.style.backgroundColor = `rgb(${c.r}, ${c.g}, ${c.b})`;
        box.title = `R:${c.r} G:${c.g} B:${c.b}`;
        colorListDiv.appendChild(box);
      });
    }

    function clearColors() {
      selectedColors = [];
      updateColorList();
    }

    function colorsAreClose(c1, c2, tolerance = 15) {
      return (
        Math.abs(c1.r - c2.r) <= tolerance &&
        Math.abs(c1.g - c2.g) <= tolerance &&
        Math.abs(c1.b - c2.b) <= tolerance
      );
    }

    function removeWatermark() {
      if (!imgLoaded || selectedColors.length === 0) return;
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imgData.data;

      for (let i = 0; i < data.length; i += 4) {
        const pixel = { r: data[i], g: data[i + 1], b: data[i + 2] };
        for (const targetColor of selectedColors) {
          if (colorsAreClose(pixel, targetColor)) {
            data[i] = 255;
            data[i + 1] = 255;
            data[i + 2] = 255;
            break;
          }
        }
      }

      ctx.putImageData(imgData, 0, 0);
    }

    function saveImage() {
      const link = document.createElement('a');
      link.download = 'image_sans_watermark.png';
      link.href = canvas.toDataURL();
      link.click();
    }
  </script>
</body>
</html>
